<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KRUUTHIK FROZEN FOODS Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #ff4757; --secondary: #2ed573; --dark: #2f3542; --light: #f1f2f6; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: var(--light); color: var(--dark); }
        
        /* Navigation */
        nav { background: white; padding: 1rem 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        .nav-btn { padding: 10px 20px; border: none; background: var(--dark); color: white; cursor: pointer; border-radius: 5px; font-weight: bold; margin-left: 10px; }
        .nav-btn:hover { background-color: var(--primary); }

        /* Layout */
        .container { max-width: 1000px; margin: 2rem auto; padding: 0 1rem; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e1e1e1; }
        
        /* Forms */
        input, select { padding: 12px; margin: 8px 0; border: 1px solid #ced6e0; border-radius: 6px; width: 100%; box-sizing: border-box; }
        button { padding: 12px; border-radius: 6px; cursor: pointer; border: none; font-weight: bold; }
        .btn-success { background: var(--secondary); color: white; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: #ff4757; color: white; }

        /* Bill Styles */
        .bill-header-content { text-align: center; margin-bottom: 20px; border-bottom: 2px dashed #ccc; padding-bottom: 20px; }
        
        /* UPDATED LOGO STYLE */
        .bill-logo { 
            max-width: 200px; /* Made logo slightly bigger */
            height: auto; 
            display: block; 
            margin: 0 auto 10px auto; 
        }

        .factory-title { margin: 0; color: var(--primary); font-size: 28px; font-weight: 900; text-transform: uppercase; }
        .invoice-details { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; background: #f8f9fa; padding: 15px; border-radius: 8px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: var(--dark); color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        
        .totals-area { margin-top: 20px; text-align: right; font-size: 1.2rem; background: #fff3f3; padding: 15px; border-radius: 8px; }

        /* Status Bar */
        #db-status { text-align: center; padding: 10px; color: white; font-weight: bold; display: none; }

        /* Signatures & Print */
        .signatures { display: none; justify-content: space-between; margin-top: 60px; padding-top: 20px; }
        .sign-box { border-top: 2px solid black; width: 200px; text-align: center; font-weight: bold; }

        @media print {
            body * { visibility: hidden; }
            #bill-section, #bill-section * { visibility: visible; }
            #bill-section { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            .signatures { display: flex; }
            input { border: none; background: transparent; padding: 0; }
        }

        /* Admin Modal */
        #login-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: white; padding: 2rem; border-radius: 15px; width: 350px; text-align: center; }
        #admin-panel { display: none; }
        
        /* Item List in Admin */
        .admin-item-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <div id="db-status"></div>

    <nav class="no-print">
        <div class="logo">üç¶ Kruuthik Frozen Foods</div>
        <div>
            <button class="nav-btn" onclick="showSection('pos')">Create Bill</button>
            <button class="nav-btn" onclick="openLoginModal()">Admin Dashboard</button>
        </div>
    </nav>

    <div class="container">
        <div id="pos-section" class="card">
            <div id="bill-section">
                <div class="bill-header-content">
                    
                    <img src="charan.jpg" alt="Sky Moon Logo (Save image as charan.jpeg)" class="bill-logo" onerror="this.style.display='none'; alert('Logo missing! Make sure charan.jpeg is in the same folder.');">
                    
                    <h1 class="factory-title">KRUUTHIK FROZEN FOODS</h1>
                    <p style="margin:5px; font-weight:bold;">2/4/A, GODOWN NO.2, INDUSTRIAL ESTATE, SAMARLAKOTA-533440</p>
                    <p style="margin:5px;">KAKINADA DIST (AP)</p>
                    <p style="margin:5px;">PH: 7659899666 / 9553325188 | Email: SKYMOON99666@GMAIL.COM</p>
                    <p style="margin:5px; font-weight: bold;">GSTIN: 37AOXPG3090D1ZQ</p>
                </div>

                <div class="invoice-details">
                    <div>
                        <strong style="color: var(--primary);">BILL TO:</strong><br>
                        <input type="text" id="cust-name" placeholder="Customer Name"><br>
                        <input type="text" id="cust-phone" placeholder="Phone Number"><br>
                        <input type="text" id="cust-addr" placeholder="Address"><br>
                        <input type="text" id="cust-vehicle" placeholder="Vehicle Number">
                    </div>
                    <div style="text-align: right;">
                        <strong>Invoice #:</strong> <span id="bill-no">INV-001</span><br>
                        <strong>Date:</strong> <span id="bill-date"></span>
                    </div>
                </div>

                <table id="bill-table">
                    <thead><tr><th>Item Name</th><th>Price (‚Çπ)</th><th>Qty</th><th>Total</th><th class="no-print">X</th></tr></thead>
                    <tbody id="bill-items"></tbody>
                </table>

                <div class="no-print" style="background: #f1f2f6; padding: 15px; margin-top: 15px; border-radius: 8px; display:flex; gap:10px;">
                    <select id="item-selector" style="flex:2;"><option>Loading...</option></select>
                    <input type="number" id="item-qty" placeholder="Qty" style="flex:1;">
                    <button class="btn-success" onclick="addToBill()" style="flex:1;">Add</button>
                </div>

                <div class="totals-area">
                    <p>Subtotal: <strong>‚Çπ<span id="subtotal">0.00</span></strong></p>
                    <p>GST (5%): <strong>‚Çπ<span id="gst">0.00</span></strong></p>
                    <h3 style="color: var(--primary);">Grand Total: ‚Çπ<span id="grand-total">0.00</span></h3>
                </div>

                <div class="signatures">
                    <div class="sign-box">Accountant Signature</div>
                    <div class="sign-box">Receiver Signature</div>
                </div>
            </div>
            <div class="no-print" style="margin-top: 20px; text-align: center;">
                <button class="btn-primary" onclick="printBill()" style="width: 200px;">üñ®Ô∏è PRINT BILL</button>
            </div>
        </div>

        <div id="admin-panel">
            <button onclick="showSection('pos')" class="nav-btn" style="margin-bottom:20px;">‚Üê Back to Billing</button>
            <div class="card">
                <h2>Manage Inventory</h2>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-item-name" placeholder="Item Name">
                    <input type="number" id="new-item-price" placeholder="Price">
                    <button class="btn-success" onclick="addInventoryItem()">Add Item</button>
                </div>
                <div id="inventory-list" style="margin-top:10px; max-height: 300px; overflow-y:auto;">Loading...</div>
            </div>
            <div class="card">
                <h2>Today's Expenses</h2>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="expense-desc" placeholder="Expense (e.g. Milk)">
                    <input type="number" id="expense-amount" placeholder="Amount">
                    <button class="btn-primary" onclick="addExpense()">Record</button>
                </div>
                <ul id="expense-list"></ul>
            </div>
        </div>
    </div>

    <div id="login-modal">
        <div class="login-box">
            <h2>Admin Login</h2>
            <input type="text" id="admin-user" placeholder="Username (admin)">
            <input type="password" id="admin-pass" placeholder="Password">
            <br><br>
            <button class="btn-primary" style="width: 100%;" onclick="performLogin()">Login</button>
            <button class="btn-danger" style="width: 100%; margin-top: 10px;" onclick="closeLogin()">Cancel</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const supabaseUrl = 'https://sbdbtjvgmzbdogjaowum.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNiZGJ0anZnbXpiZG9namFvd3VtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NDY3NDksImV4cCI6MjA4NTUyMjc0OX0.Y8b_eRJAMxmOJX92hqeodfJI9sZBjm_czDd4zJreFss';

        // -----------------------
        
        let dbClient = null; 
        let isDbConnected = false;
        let inventory = [];
        let currentBill = [];

        window.onload = async function() {
            document.getElementById('bill-date').innerText = new Date().toLocaleDateString();
            const statusEl = document.getElementById('db-status');

            try {
                if (window.supabase && window.supabase.createClient) {
                    dbClient = window.supabase.createClient(supabaseUrl, supabaseKey);
                } else {
                    throw new Error("Supabase Library not loaded");
                }

                const { data, error } = await dbClient.from('inventory').select('count', { count: 'exact', head: true });
                
                if (error) throw error;

                isDbConnected = true;
                statusEl.style.display = 'block';
                statusEl.style.background = '#2ed573';
                statusEl.innerText = "‚úÖ Database Connected Successfully";
                
                await fetchInventory();
                await fetchExpenses();

            } catch (err) {
                console.error(err);
                statusEl.style.display = 'block';
                statusEl.style.background = '#ff4757';
                statusEl.innerText = "‚ùå Connection Failed: " + err.message;
            }
        };

        // --- Database Functions ---
        async function fetchInventory() {
            if(!isDbConnected) return;
            const { data, error } = await dbClient.from('inventory').select('*').order('name');
            if(data) { 
                inventory = data; 
                renderInventorySelect(); 
                renderInventoryAdmin(); 
            }
        }

        async function addInventoryItem() {
            if(!isDbConnected) return alert("Database not connected!");
            const name = document.getElementById('new-item-name').value;
            const price = document.getElementById('new-item-price').value;
            if(!name || !price) return;
            
            const { error } = await dbClient.from('inventory').insert([{name, price}]);
            if(error) alert(error.message);
            else { 
                document.getElementById('new-item-name').value = ''; 
                document.getElementById('new-item-price').value = ''; 
                await fetchInventory(); 
            }
        }

        async function deleteItem(id) {
            if(!isDbConnected || !confirm("Delete item?")) return;
            await dbClient.from('inventory').delete().eq('id', id);
            await fetchInventory();
        }

        async function fetchExpenses() {
            if(!isDbConnected) return;
            const { data } = await dbClient.from('expenses').select('*').limit(10).order('created_at', {ascending:false});
            if(data) {
                const list = document.getElementById('expense-list');
                list.innerHTML = '';
                data.forEach(e => {
                    list.innerHTML += `<li>${e.description}: ‚Çπ${e.amount}</li>`;
                });
            }
        }

        async function addExpense() {
            if(!isDbConnected) return alert("Database not connected!");
            const description = document.getElementById('expense-desc').value;
            const amount = document.getElementById('expense-amount').value;
            if(!description) return;

            await dbClient.from('expenses').insert([{description, amount}]);
            document.getElementById('expense-desc').value = '';
            document.getElementById('expense-amount').value = '';
            await fetchExpenses();
        }

        // --- Billing Functions ---
        function renderInventorySelect() {
            const sel = document.getElementById('item-selector');
            sel.innerHTML = '<option value="">-- Select --</option>';
            inventory.forEach((item, idx) => {
                sel.innerHTML += `<option value="${idx}">${item.name} - ‚Çπ${item.price}</option>`;
            });
        }

        function addToBill() {
            const idx = document.getElementById('item-selector').value;
            const qty = document.getElementById('item-qty').value;
            if(idx === "" || !qty) return;
            
            const item = inventory[idx];
            currentBill.push({ ...item, qty, total: item.price * qty });
            renderBill();
            document.getElementById('item-qty').value = '';
        }

        function remItem(idx) {
            currentBill.splice(idx, 1);
            renderBill();
        }

        function renderBill() {
            const tbody = document.getElementById('bill-items');
            tbody.innerHTML = '';
            let sub = 0;
            currentBill.forEach((item, i) => {
                sub += item.total;
                tbody.innerHTML += `<tr><td>${item.name}</td><td>${item.price}</td><td>${item.qty}</td><td>${item.total}</td><td class="no-print"><button class="btn-danger" onclick="remItem(${i})">X</button></td></tr>`;
            });
            
            const gst = sub * 0.05;
            document.getElementById('subtotal').innerText = sub.toFixed(2);
            document.getElementById('gst').innerText = gst.toFixed(2);
            document.getElementById('grand-total').innerText = (sub + gst).toFixed(2);
        }

        function printBill() {
            if(currentBill.length > 0) window.print();
            else alert("Bill Empty");
        }

        // --- Admin Functions ---
        function renderInventoryAdmin() {
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';
            inventory.forEach(item => {
                list.innerHTML += `
                    <div class="admin-item-row">
                        <span>${item.name} (‚Çπ${item.price})</span>
                        <button class="btn-danger" style="padding:2px 8px;" onclick="deleteItem(${item.id})">Delete</button>
                    </div>`;
            });
        }

        function openLoginModal() { document.getElementById('login-modal').style.display = 'flex'; }
        function closeLogin() { document.getElementById('login-modal').style.display = 'none'; }
        
        function performLogin() {
            const u = document.getElementById('admin-user').value;
            const p = document.getElementById('admin-pass').value;
            if(u === "admin" && p === "icecream123") {
                closeLogin();
                showSection('admin');
            } else {
                alert("Wrong Username or Password! (Try: admin / icecream123)");
            }
        }

        function showSection(sec) {
            document.getElementById('pos-section').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'none';
            if(sec === 'pos') document.getElementById('pos-section').style.display = 'block';
            if(sec === 'admin') document.getElementById('admin-panel').style.display = 'block';
        }
    </script>
</body>

</html>
